name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Test Supabase credentials (demo keys, safe to commit)
env:
  SUPABASE_URL: http://127.0.0.1:54421
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
  SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
  SUPABASE_DB_HOST: 127.0.0.1
  SUPABASE_DB_PORT: 54422
  SUPABASE_DB_USER: postgres
  SUPABASE_DB_PASSWORD: postgres
  SUPABASE_DB_NAME: postgres

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Lint - Biome check (~30s)
  # ═══════════════════════════════════════════════════════════════════════════
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install

      - name: Run Biome lint
        run: bun run lint

  # ═══════════════════════════════════════════════════════════════════════════
  # Unit Tests - Vitest with mocks (~30s)
  # ═══════════════════════════════════════════════════════════════════════════
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install

      - name: Run unit tests
        run: bun run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════
  # Integration Tests - Vitest + Supabase (~2 min)
  # ═══════════════════════════════════════════════════════════════════════════
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install

      # ─────────────────────────────────────────────────────────────
      # Supabase Setup
      # ─────────────────────────────────────────────────────────────
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start test Supabase
        run: |
          bunx supabase --workdir supabase-test start
          bunx supabase --workdir supabase-test db reset

      # ─────────────────────────────────────────────────────────────
      # Run Tests
      # ─────────────────────────────────────────────────────────────
      - name: Run integration tests
        run: bun run test:integration

      - name: Stop Supabase
        if: always()
        run: bunx supabase --workdir supabase-test stop

  # ═══════════════════════════════════════════════════════════════════════════
  # E2E Tests - Playwright + Supabase (~4 min)
  # ═══════════════════════════════════════════════════════════════════════════
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────
      # Bun Setup
      # ─────────────────────────────────────────────────────────────
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install

      # ─────────────────────────────────────────────────────────────
      # Playwright Setup
      # ─────────────────────────────────────────────────────────────
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install chromium --with-deps

      - name: Install Playwright system deps (cached browsers)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: bunx playwright install-deps chromium

      # ─────────────────────────────────────────────────────────────
      # Supabase Setup
      # ─────────────────────────────────────────────────────────────
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start test Supabase
        run: |
          bunx supabase --workdir supabase-test start
          bunx supabase --workdir supabase-test db reset

      # ─────────────────────────────────────────────────────────────
      # Test Environment
      # ─────────────────────────────────────────────────────────────
      - name: Create test env file
        run: |
          cat > .env.test.local << EOF
          SUPABASE_URL=${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ env.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_HOST=${{ env.SUPABASE_DB_HOST }}
          SUPABASE_DB_PORT=${{ env.SUPABASE_DB_PORT }}
          SUPABASE_DB_USER=${{ env.SUPABASE_DB_USER }}
          SUPABASE_DB_PASSWORD=${{ env.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_NAME=${{ env.SUPABASE_DB_NAME }}
          EOF

      # ─────────────────────────────────────────────────────────────
      # Next.js Build
      # ─────────────────────────────────────────────────────────────
      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('bun.lock') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('bun.lock') }}-
            nextjs-${{ runner.os }}-

      - name: Build Next.js
        run: bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}

      # ─────────────────────────────────────────────────────────────
      # Run E2E Tests
      # ─────────────────────────────────────────────────────────────
      - name: Run E2E tests
        run: bun run test:e2e
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Stop Supabase
        if: always()
        run: bunx supabase --workdir supabase-test stop
