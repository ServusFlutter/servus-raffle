name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Test Supabase credentials (demo keys, safe to commit)
env:
  SUPABASE_URL: http://127.0.0.1:54421
  SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
  SUPABASE_SERVICE_ROLE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
  SUPABASE_DB_HOST: 127.0.0.1
  SUPABASE_DB_PORT: 54422
  SUPABASE_DB_USER: postgres
  SUPABASE_DB_PASSWORD: postgres
  SUPABASE_DB_NAME: postgres

jobs:
  e2e:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start test Supabase
        run: |
          bunx supabase --workdir supabase-test start
          bunx supabase --workdir supabase-test db reset

      - name: Create test env file
        run: |
          cat > .env.test.local << EOF
          SUPABASE_URL=${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ env.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_HOST=${{ env.SUPABASE_DB_HOST }}
          SUPABASE_DB_PORT=${{ env.SUPABASE_DB_PORT }}
          SUPABASE_DB_USER=${{ env.SUPABASE_DB_USER }}
          SUPABASE_DB_PASSWORD=${{ env.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_NAME=${{ env.SUPABASE_DB_NAME }}
          EOF

      - name: Build Next.js
        run: bun run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}

      - name: Run E2E tests
        run: bun run test:e2e
        env:
          CI: true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Stop Supabase
        if: always()
        run: bunx supabase --workdir supabase-test stop
